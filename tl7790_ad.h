/*
 * include/video/tl7790_ad.h
 *
 * Copyright (C) 2016 Nufront Corporation
 *
 * This software is licensed under the terms of the GNU General Public
 * License version 2, as published by the Free Software Foundation, and
 * may be copied, distributed, and modified under those terms.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 */

#ifndef __TL7790_APICAL_AD__
#define __TL7790_APICAL_AD__

/*
 * Apical Assertive Display IP core registers.
 * The register name with "AD_VP_" prefix means this register is in video pipeline
 * configuration ports, otherwise, the resiger is in non-video pipeline configuration
 * ports.
 */

/**** Video Pipeline Registers ****/
#define AD_VP_CONTROL_REG0				0x0
#define AD_VP_CONTROL_REG1				0x4
#define AD_VP_FRAME_WIDTH_L				0x10
#define AD_VP_FRAME_WIDTH_L_MASK			0xFF
#define AD_VP_FRAME_WIDTH_H				0x14
#define AD_VP_FRAME_WIDTH_H_MASK			0xFF
#define AD_VP_FRAME_HEIGHT_L				0x18
#define AD_VP_FRAME_HEIGHT_L_MASK			0xFF
#define AD_VP_FRAME_HEIGHT_H				0x1C
#define AD_VP_FRAME_HEIGHT_H_MASK			0xFF
#define AD_VP_IRIDIX_CONTROL_0				0x400
#define AD_VP_IRIDIX_CONTROL_0_MASK			0x17
#define AD_VP_IRIDIX_CONTROL_1				0x404
#define AD_VP_IRIDIX_CONTROL_1_MASK			0xC0
#define AD_VP_VARIANCE					0x40C
#define AD_VP_VARIANCE_MASK				0xFF
#define AD_VP_SLOPE_MAX					0x410
#define AD_VP_SLOPE_MAX_MASK				0xFF
#define AD_VP_SLOPE_MIN					0x414
#define AD_VP_SLOPE_MIN_MASK				0xFF
#define AD_VP_BLACK_LEVEL_L				0x418
#define AD_VP_BLACK_LEVEL_L_MASK			0xFF
#define AD_VP_BLACK_LEVEL_H				0x41C
#define AD_VP_BLACK_LEVEL_H_MASK			0x3
#define AD_VP_WHITE_LEVEL_L				0x420
#define AD_VP_WHITE_LEVEL_L_MASK			0xFF
#define AD_VP_WHITE_LEVEL_H				0x424
#define AD_VP_WHITE_LEVEL_H_MASK			0x3
#define AD_VP_LIMIT_AMPL				0x428
#define AD_VP_LIMIT_AMPL_MASK				0xFF
#define AD_VP_IRIDIX_DITHER				0x42C
#define AD_VP_IRIDIX_DITHER_MASK			0x7
#define AD_VP_IRIDIX_ASYMMETRY_LUT_ADDR_MASK		0x3F
#define AD_VP_IRIDIX_ASYMMETRY_LUT_ADDR_I		0x480
#define AD_VP_IRIDIX_ASYMMETRY_LUT_DATA_W_L		0x484
#define AD_VP_IRIDIX_ASYMMETRY_LUT_DATA_W_H		0x488
#define AD_VP_IRIDIX_COLOR_CORRECTION_LUT_ADDR_I_MASK	0x3F
#define AD_VP_IRIDIX_COLOR_CORRECTION_LUT_ADDR_I	0x4C0
#define AD_VP_IRIDIX_COLOR_CORRECTION_LUT_DATA_W_L	0x4C4
#define AD_VP_IRIDIX_COLOR_CORRECTION_LUT_DATA_W_H	0x4C8
#define AD_VP_LOGO_LEFT					0x800
#define AD_VP_LOGO_LEFT_MASK				0xFF
#define AD_VP_LOGO_TOP					0x804
#define AD_VP_LOGO_TOP_MASK				0xFF
#define AD_VP_APICAL_DITHER_CONTROL			0x840
#define AD_VP_APICAL_DITHER_CONTROL_MASK		0xF

/**** Non-video Pipeline Registers ****/
#define AD_HS_POS_L					0x8
#define AD_HS_POS_H					0xC
#define AD_VS_POS_L					0x20
#define AD_VS_POS_H					0x24
#define AD_IRIDIX_STRENGTH				0x408
#define AD_CONFIG_BUFFER_MODE				0x430
#define AD_CONFIG_BUFFER_GLOBAL				0x434
#define AD_OPTION_SELECT				0xC00
#define AD_STRENGTH_MANUAL				0xC04
#define AD_DRC_IN_L					0xC08
#define AD_DRC_IN_H					0xC0C
#define AD_BACKLIGHT_L					0xC10
#define AD_BACKLIGHT_L_MASK				0xFF
#define AD_BACKLIGHT_H					0xC14
#define AD_BACKLIGHT_H_MASK				0xFF
#define AD_AMBIENT_LIGHT_L				0xC18
#define AD_AMBIENT_LIGHT_H				0xC1C
#define AD_START_CALC					0xC20
#define AD_START_CALC_MASK				0x1
#define AD_STRENGTH_LIMIT				0xC24
#define AD_CALIBRATION_A_L				0xC28
#define AD_CALIBRATION_A_H				0xC2C
#define AD_CALIBRATION_B_L				0xC30
#define AD_CALIBRATION_B_H				0xC34
#define AD_CALIBRATION_C_L				0xC38
#define AD_CALIBRATION_C_H				0xC3C
#define AD_CALIBRATION_D_L				0xC40
#define AD_CALIBRATION_D_H				0xC44
#define AD_T_FILTER_CONTROL				0xC48
#define AD_BACKLIGHT_MIN_L				0xC4C
#define AD_BACKLIGHT_MIN_H				0xC50
#define AD_BACKLIGHT_MAX_L				0xC54
#define AD_BACKLIGHT_MAX_H				0xC58
#define AD_BACKLIGHT_SCALE_L				0xC5C
#define AD_BACKLIGHT_SCALE_H				0xC60
#define AD_AMBIENT_LIGHT_MIN_L				0xC64
#define AD_AMBIENT_LIGHT_MIN_H				0xC68
#define AD_FILTER_A_L					0xC6C
#define AD_FILTER_A_H					0xC70
#define AD_FILTER_B					0xC74
#define AD_AL_CALIB_LUT_ADDR_I_MASK			0x3F
#define AD_AL_CALIB_LUT_ADDR_I				0xF00
#define AD_AL_CALIB_LUT_DATA_W_L			0xF10
#define AD_AL_CALIB_LUT_DATA_W_H			0xF14

/**** Read-only Registers ****/
#define AD_STRENGTH_OUT					0xC80
#define AD_DRC_OUT_L					0xC84
#define AD_DRC_OUT_H					0xC88
#define AD_BACKLIGHT_OUT_L				0xC8C
#define AD_BACKLIGHT_OUT_H				0xC90
#define AD_CALC_DONE					0xC94


/* #define AD_OPTION_SELECT */
#define	AD_OPTION_SELECT_FUNCTIONAL_MODE0		0
#define AD_OPTION_SELECT_FUNCTIONAL_MODE1		1
#define	AD_OPTION_SELECT_FUNCTIONAL_MODE3		3
#define AD_OPTION_SELECT_FUNCTIONAL_MODE7		7
#define AD_OPTION_SELECT_FUNCTIONAL_MASK		0xF

#define AD_OPTION_SELECT_CALCTRIGGER_MANUAL		0 << 4
#define AD_OPTION_SELECT_CALCTRIGGER_AUTO		8 << 4
#define AD_OPTION_SELECT_TRIGGER_MODE_MASK		0xF << 4

#define BL_LIN_LUT_NUM					257
#define BL_ATT_LUT_NUM					34

struct al_bl_mapping {
	int al;
	int bl;
};

struct tl7790_ad_device {

	int brightness;

	unsigned int assertiveness;
	unsigned int calibration_mode;

	struct device *device;		/* This is the parent */
	struct device *dev;
	unsigned int minor;

	struct mutex ops_lock;
	struct mutex al_lock;
	struct mutex bl_lock;

	int abm_size;
	struct al_bl_mapping *abm;
	struct notifier_block ad_notif;
	struct delayed_work auto_brightness_work;

};

struct backlight_process
{
	int alpha;
	int bl_lin_lut[BL_LIN_LUT_NUM];
	int bl_lin_inverse_lut[BL_LIN_LUT_NUM];
	int bl_att_lut[BL_ATT_LUT_NUM];
};

extern int nu7tlbl_set_brightness(int new);

struct al_bl_mapping sample_abm[] =
{
	{   20,  20},
	{   50,  40},
	{   80,  60},
	{  100,  80},
	{  150, 100},
	{  200, 120},
	{  300, 150},
	{  350, 160},
	{  400, 170},
	{  500, 180},
	{ 1000, 190},
	{ 2000, 200},
	{ 3000, 210},
	{ 4000, 220},
	{ 5000, 230},
	{ 6000, 240},
	{10000, 250},
};

char *ad_calibrated_settings_ad_init = {
	"ad:init;0,211,414,609,796,975,1148,1315,1475,1630,1779,1922,2061,2195,2325,2451,2572,2690,2804,2915,3022,3126,3227,3325,3420,3513,3603,3691,3776,3859,3940,4019,4095;255,278,302,326,350,374,398,422,446,470,494,517,541,565,589,613,637,661,684,708,732,755,779,803,826,850,874,897,921,945,968,992,1016;7,134;0;1023;65;240;0;60;128;5;3;0;720;1280;16;1;0,16,32,48,64,80,96,112,128,145,161,177,193,209,225,241,257,273,289,305,321,337,353,369,385,401,418,434,450,466,482,498,514,530,546,562,578,594,610,626,642,658,674,691,707,723,739,755,771,787,803,819,835,851,867,883,899,915,931,947,964,980,996,1012,1028,1044,1060,1076,1092,1108,1124,1140,1156,1172,1188,1204,1220,1237,1253,1269,1285,1301,1317,1333,1349,1365,1381,1397,1413,1429,1445,1461,1477,1493,1510,1526,1542,1558,1574,1590,1606,1622,1638,1654,1670,1686,1702,1718,1734,1750,1766,1783,1799,1815,1831,1847,1863,1879,1895,1911,1927,1943,1959,1975,1991,2007,2023,2039,2056,2072,2088,2104,2120,2136,2152,2168,2184,2200,2216,2232,2248,2264,2280,2296,2312,2329,2345,2361,2377,2393,2409,2425,2441,2457,2473,2489,2505,2521,2537,2553,2569,2585,2602,2618,2634,2650,2666,2682,2698,2714,2730,2746,2762,2778,2794,2810,2826,2842,2858,2875,2891,2907,2923,2939,2955,2971,2987,3003,3019,3035,3051,3067,3083,3099,3115,3131,3148,3164,3180,3196,3212,3228,3244,3260,3276,3292,3308,3324,3340,3356,3372,3388,3404,3421,3437,3453,3469,3485,3501,3517,3533,3549,3565,3581,3597,3613,3629,3645,3661,3677,3694,3710,3726,3742,3758,3774,3790,3806,3822,3838,3854,3870,3886,3902,3918,3934,3950,3967,3983,3999,4015,4031,4047,4063,4079,4095;0,16,32,48,64,80,96,112,128,145,161,177,193,209,225,241,257,273,289,305,321,337,353,369,385,401,418,434,450,466,482,498,514,530,546,562,578,594,610,626,642,658,674,691,707,723,739,755,771,787,803,819,835,851,867,883,899,915,931,947,964,980,996,1012,1028,1044,1060,1076,1092,1108,1124,1140,1156,1172,1188,1204,1220,1237,1253,1269,1285,1301,1317,1333,1349,1365,1381,1397,1413,1429,1445,1461,1477,1493,1510,1526,1542,1558,1574,1590,1606,1622,1638,1654,1670,1686,1702,1718,1734,1750,1766,1783,1799,1815,1831,1847,1863,1879,1895,1911,1927,1943,1959,1975,1991,2007,2023,2039,2056,2072,2088,2104,2120,2136,2152,2168,2184,2200,2216,2232,2248,2264,2280,2296,2312,2329,2345,2361,2377,2393,2409,2425,2441,2457,2473,2489,2505,2521,2537,2553,2569,2585,2602,2618,2634,2650,2666,2682,2698,2714,2730,2746,2762,2778,2794,2810,2826,2842,2858,2875,2891,2907,2923,2939,2955,2971,2987,3003,3019,3035,3051,3067,3083,3099,3115,3131,3148,3164,3180,3196,3212,3228,3244,3260,3276,3292,3308,3324,3340,3356,3372,3388,3404,3421,3437,3453,3469,3485,3501,3517,3533,3549,3565,3581,3597,3613,3629,3645,3661,3677,3694,3710,3726,3742,3758,3774,3790,3806,3822,3838,3854,3870,3886,3902,3918,3934,3950,3967,3983,3999,4015,4031,4047,4063,4079,4095;512;0,128,256,384,470,559,618,665,706,745,785,826,872,924,982,1047,1118,1198,1285,1382,1490,1608,1738,1881,2039,2213,2405,2618,2853,3115,3406,3731,4095;100;0.5"
};

char *ad_calibrated_settings_ad_config = {
	"ad:config;1;0,2048,4096,6144,8192,10240,12288,14336,16384,18432,20480,22528,24576,26624,28672,30720,32768,34815,36863,38911,40959,43007,45055,47103,49151,51199,53247,55295,57343,59391,61439,63487,65535;205;4095;4095;14;1738,6;2,95,7,2;128;5;60"
};

#endif
